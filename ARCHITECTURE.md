# å°ˆæ¡ˆæ¶æ§‹èªªæ˜

## æŠ€è¡“æ¶æ§‹ç¸½è¦½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               User Interface (UI)               â”‚
â”‚  (React Components + Tailwind CSS)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           Application Logic Layer               â”‚
â”‚  (Next.js App Router + React Hooks)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           Data Access Layer (DAL)               â”‚
â”‚  (lib/data-source.ts - Abstraction)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              Data Source Layer                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ JSON Files   â”‚ OR   â”‚  Supabase    â”‚        â”‚
â”‚  â”‚ (Current)    â”‚      â”‚  (Future)    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ç›®éŒ„çµæ§‹èˆ‡è·è²¬

### `/app` - Next.js App Router

```
app/
â”œâ”€â”€ layout.tsx      # æ ¹å¸ƒå±€ï¼Œå®šç¾©å…¨å±€å…ƒæ•¸æ“šå’Œ HTML çµæ§‹
â”œâ”€â”€ page.tsx        # é¦–é ï¼Œä¸»è¦åœ°åœ–ä»‹é¢é‚è¼¯
â””â”€â”€ globals.css     # å…¨å±€æ¨£å¼ï¼ŒåŒ…å« Tailwind æŒ‡ä»¤å’Œè‡ªå®šç¾© CSS
```

**é—œéµè¨­è¨ˆ**:
- ä½¿ç”¨ Next.js 15 App Router æ¶æ§‹
- å®¢æˆ¶ç«¯æ¸²æŸ“ (`'use client'`) ä»¥æ”¯æ´åœ°åœ–äº’å‹•
- å‹•æ…‹å°å…¥åœ°åœ–çµ„ä»¶é¿å… SSR å•é¡Œ

### `/components` - React çµ„ä»¶

```
components/
â”œâ”€â”€ Map.tsx          # MapLibre åœ°åœ–çµ„ä»¶
â”œâ”€â”€ SearchBar.tsx    # æœå°‹æ¬„çµ„ä»¶
â”œâ”€â”€ FilterPanel.tsx  # ç¯©é¸é¢æ¿çµ„ä»¶
â””â”€â”€ VenueCard.tsx    # å ´åœ°å¡ç‰‡çµ„ä»¶
```

**è¨­è¨ˆåŸå‰‡**:
- **å–®ä¸€è·è²¬**: æ¯å€‹çµ„ä»¶å°ˆæ³¨æ–¼å–®ä¸€åŠŸèƒ½
- **å¯é‡ç”¨æ€§**: çµ„ä»¶è¨­è¨ˆç‚ºå¯åœ¨ä¸åŒå ´æ™¯é‡ç”¨
- **Props é©…å‹•**: é€šé props æ¥æ”¶æ•¸æ“šå’Œå›èª¿å‡½æ•¸
- **TypeScript**: åš´æ ¼çš„å‹åˆ¥æª¢æŸ¥ç¢ºä¿ä»‹é¢ä¸€è‡´æ€§

#### Map.tsx ç‰¹é»

- ä½¿ç”¨ `react-map-gl` å°è£ MapLibre GL JS
- å‹•æ…‹ Marker é¡è‰²åŸºæ–¼éŸ³æ¨‚é¡å‹
- Popup çµ„ä»¶é¡¯ç¤ºå ´åœ°å¿«é€Ÿé è¦½
- æ”¯æ´é»æ“Šäº‹ä»¶èˆ‡çˆ¶çµ„ä»¶é€šè¨Š
- ä½¿ç”¨ `useMemo` å„ªåŒ–æ€§èƒ½

#### SearchBar.tsx ç‰¹é»

- å³æ™‚æœå°‹ï¼ˆonChange è§¸ç™¼ï¼‰
- å¯æ¸…é™¤åŠŸèƒ½
- éŸ¿æ‡‰å¼è¨­è¨ˆï¼Œé©æ‡‰ä¸åŒè¢å¹•å°ºå¯¸

#### FilterPanel.tsx ç‰¹é»

- å¤šé¸æ¨™ç±¤ä»‹é¢
- è¦–è¦ºåŒ–å·²é¸æ“‡ç‹€æ…‹
- æ¸…é™¤å…¨éƒ¨åŠŸèƒ½
- é¡¯ç¤ºå·²é¸æ“‡æ¢ä»¶çµ±è¨ˆ

#### VenueCard.tsx ç‰¹é»

- å±•ç¤ºå®Œæ•´å ´åœ°è³‡è¨Š
- æ”¯æ´é¸ä¸­ç‹€æ…‹è¦–è¦ºå›é¥‹
- Icon + æ–‡å­—çš„è³‡è¨Šå‘ˆç¾
- æ–‡å­—æˆªæ–·è™•ç†ï¼ˆline-clampï¼‰

### `/lib` - å·¥å…·å‡½æ•¸èˆ‡è³‡æ–™å­˜å–å±¤

```
lib/
â””â”€â”€ data-source.ts   # è³‡æ–™å­˜å–æŠ½è±¡å±¤
```

**æ ¸å¿ƒè¨­è¨ˆæ¨¡å¼**: **ç­–ç•¥æ¨¡å¼ (Strategy Pattern)**

```typescript
// å®šç¾©è³‡æ–™æºä»‹é¢
interface IVenueDataSource {
  getAllVenues(): Promise<Venue[]>;
  getVenueById(id: string): Promise<Venue | null>;
  getFilteredVenues(filter: VenueFilter): Promise<Venue[]>;
  searchVenues(query: string): Promise<Venue[]>;
}

// å¯¦ä½œ 1: JSON è³‡æ–™æº
class JSONVenueDataSource implements IVenueDataSource { ... }

// å¯¦ä½œ 2: Supabase è³‡æ–™æºï¼ˆé ç•™ï¼‰
class SupabaseVenueDataSource implements IVenueDataSource { ... }

// å·¥å» å‡½æ•¸é¸æ“‡è³‡æ–™æº
function createVenueDataSource(): IVenueDataSource { ... }
```

**å„ªé»**:
1. **ä½è€¦åˆ**: UI å±¤ä¸ç›´æ¥ä¾è³´è³‡æ–™ä¾†æº
2. **æ˜“æ“´å±•**: æ–°å¢è³‡æ–™æºåªéœ€å¯¦ä½œä»‹é¢
3. **æ˜“æ¸¬è©¦**: å¯æ³¨å…¥ mock è³‡æ–™æºé€²è¡Œå–®å…ƒæ¸¬è©¦
4. **æ˜“é·ç§»**: åˆ‡æ›è³‡æ–™æºåªéœ€ä¿®æ”¹å·¥å» å‡½æ•¸

### `/types` - TypeScript å‹åˆ¥å®šç¾©

```
types/
â””â”€â”€ venue.ts         # å ´åœ°ç›¸é—œå‹åˆ¥å®šç¾©
```

**å‹åˆ¥å®‰å…¨ç­–ç•¥**:
- é›†ä¸­å®šç¾©æ‰€æœ‰æ¥­å‹™æ¨¡å‹
- ä½¿ç”¨ `interface` å®šç¾©è³‡æ–™çµæ§‹
- ä½¿ç”¨ `type` å®šç¾©çµ„åˆå‹åˆ¥
- å°å‡ºä¾›å…¨å°ˆæ¡ˆä½¿ç”¨

### `/data` - è³‡æ–™æª”æ¡ˆ

```
data/
â””â”€â”€ venues.json      # å ´åœ°è³‡æ–™ï¼ˆåŒ…å«é‡‘çµ²é›€æ•¸æ“šï¼‰
```

**è³‡æ–™ç‰¹é»**:
- çµæ§‹åŒ– JSON æ ¼å¼
- åŒ…å«ç‰ˆæœ¬è™Ÿèˆ‡æœ€å¾Œæ›´æ–°æ™‚é–“
- å…§åµŒé‡‘çµ²é›€æ•¸æ“šï¼ˆ`is_canary: true`ï¼‰ç”¨æ–¼é˜²çˆ¬èŸ²
- è¨­è¨ˆèˆ‡ Supabase è³‡æ–™è¡¨çµæ§‹ä¸€è‡´

## é—œéµæŠ€è¡“æ±ºç­–

### 1. ç‚ºä½•ä½¿ç”¨ Next.js App Routerï¼Ÿ

**å„ªé»**:
- å…§å»º SSR/SSG æ”¯æ´ï¼ˆæœªä¾†å¯ç”¨æ–¼ SEOï¼‰
- æª”æ¡ˆç³»çµ±è·¯ç”±ï¼Œçµæ§‹æ¸…æ™°
- å…§å»º API Routesï¼ˆæœªä¾†æ“´å±•å¾Œç«¯åŠŸèƒ½ï¼‰
- å„ªç•°çš„é–‹ç™¼é«”é©—ï¼ˆFast Refreshã€TypeScript æ”¯æ´ï¼‰
- Vercel éƒ¨ç½²å‹å–„

### 2. ç‚ºä½•ä½¿ç”¨ MapLibre + OpenFreeMap è€Œé Mapbox/Google Mapsï¼Ÿ

**ç†ç”±**:
- **100% å…è²»**: ç„¡éœ€è¨»å†Šã€ç„¡éœ€ Tokenã€ç„¡éœ€ä¿¡ç”¨å¡ï¼ŒçœŸæ­£çš„é›¶æˆæœ¬
- **é–‹æºè‡ªç”±**: MapLibre æ˜¯å®Œå…¨é–‹æºçš„ï¼Œç„¡ä¾›æ‡‰å•†é–å®šé¢¨éšª
- **è‡ªå®šç¾©æ¨£å¼**: å®Œå…¨æ§åˆ¶åœ°åœ–è¦–è¦ºé¢¨æ ¼ï¼Œç¬¦åˆæ–‡è—é¢¨æ ¼å®šä½
- **æ€§èƒ½**: WebGL æ¸²æŸ“ï¼Œæµæš¢çš„å‹•ç•«æ•ˆæœ
- **éš±ç§å®‰å…¨**: ç„¡éœ€æ“”å¿ƒ API Key æ´©æ¼æˆ–æ¿«ç”¨å•é¡Œ
- **é–‹ç™¼é«”é©—**: react-map-gl å®Œç¾æ”¯æ´ MapLibreï¼ŒAPI èˆ‡ Mapbox é«˜åº¦å…¼å®¹

### 3. ç‚ºä½•ä½¿ç”¨ Tailwind CSSï¼Ÿ

**å„ªå‹¢**:
- **å¿«é€Ÿé–‹ç™¼**: Utility-first é¢¨æ ¼ï¼Œç„¡éœ€åˆ‡æ›æª”æ¡ˆ
- **ä¸€è‡´æ€§**: è¨­è¨ˆç³»çµ±å…§å»ºæ–¼é…ç½®ä¸­
- **æ€§èƒ½**: è‡ªå‹•æ¸…é™¤æœªä½¿ç”¨çš„æ¨£å¼
- **éŸ¿æ‡‰å¼**: å…§å»ºéŸ¿æ‡‰å¼æ–·é»
- **å¯ç¶­è­·**: é¿å… CSS å‘½åè¡çª

### 4. ç‚ºä½•è¨­è¨ˆè³‡æ–™å­˜å–å±¤ï¼Ÿ

**æœªä¾†å¯èƒ½çš„è³‡æ–™æº**:
1. **æœ¬åœ° JSON** (ç•¶å‰) - MVP å¿«é€Ÿé©—è­‰
2. **Supabase** (Phase 2) - ç”¨æˆ¶äº’å‹•åŠŸèƒ½ï¼ˆæ‰“å¡ã€è©•è«–ï¼‰
3. **CMS** (Phase 3) - å…§å®¹ç®¡ç†ç³»çµ±
4. **GraphQL API** - æ›´è¤‡é›œçš„æŸ¥è©¢éœ€æ±‚

**æŠ½è±¡å±¤çš„åƒ¹å€¼**:
- æ¥­å‹™é‚è¼¯èˆ‡è³‡æ–™ä¾†æºè§£è€¦
- åˆ‡æ›æˆæœ¬é™è‡³æœ€ä½
- æ”¯æ´ A/B Testingï¼ˆåŒæ™‚ä½¿ç”¨å¤šå€‹è³‡æ–™æºï¼‰

## ç‹€æ…‹ç®¡ç†ç­–ç•¥

### ç•¶å‰æ–¹æ¡ˆ: React Hooks + Props

```typescript
// åœ¨ page.tsx ä¸­é›†ä¸­ç®¡ç†ç‹€æ…‹
const [allVenues, setAllVenues] = useState<Venue[]>([]);
const [filteredVenues, setFilteredVenues] = useState<Venue[]>([]);
const [selectedVenue, setSelectedVenue] = useState<Venue | null>(null);
const [filter, setFilter] = useState<VenueFilter>({});
const [searchQuery, setSearchQuery] = useState('');
```

**ç‚ºä½•ä¸ä½¿ç”¨ Redux/Zustandï¼Ÿ**
- ç•¶å‰ç‹€æ…‹é‚è¼¯ç°¡å–®ï¼Œå–®ä¸€é é¢æ‡‰ç”¨
- Props drilling æ·±åº¦åƒ… 2-3 å±¤ï¼Œå¯æ¥å—
- é¿å…éåº¦å·¥ç¨‹åŒ–

**æœªä¾†è€ƒé‡**:
- Phase 2 æ–°å¢ç”¨æˆ¶ç³»çµ±æ™‚ï¼Œå¯å¼•å…¥ Context API
- Phase 3 è¤‡é›œç‹€æ…‹é‚è¼¯æ™‚ï¼Œè©•ä¼° Zustand

## æ€§èƒ½å„ªåŒ–ç­–ç•¥

### 1. å‹•æ…‹å°å…¥åœ°åœ–çµ„ä»¶

```typescript
const Map = dynamic(() => import('@/components/Map'), {
  ssr: false, // é¿å… SSR éŒ¯èª¤ï¼ˆMapLibre ä¾è³´ window å°è±¡ï¼‰
  loading: () => <LoadingSpinner />,
});
```

### 2. useMemo å„ªåŒ–åœ°åœ– Markers

```typescript
const markers = useMemo(
  () => venues.map((venue) => <Marker key={venue.id} ... />),
  [venues, selectedVenue]
);
```

### 3. å³æ™‚æœå°‹é˜²æŠ–ï¼ˆæœªå¯¦ä½œï¼Œå¯è€ƒæ…®ï¼‰

```typescript
// å¯ä½¿ç”¨ lodash.debounce æˆ–è‡ªå®šç¾© hook
const debouncedSearch = useMemo(
  () => debounce(onSearch, 300),
  []
);
```

### 4. åœ–ç‰‡å„ªåŒ–ï¼ˆæœªä¾†ï¼‰

- ä½¿ç”¨ Next.js `<Image>` çµ„ä»¶
- WebP æ ¼å¼
- æ‡¶åŠ è¼‰

## è³‡æ–™æµå‘

```
User Action (é»æ“Šã€æœå°‹ã€ç¯©é¸)
    â†“
Event Handler in page.tsx
    â†“
Update State (useState)
    â†“
useEffect triggered
    â†“
Call Data Access Layer
    â†“
Data Source (JSON/Supabase)
    â†“
Update filteredVenues state
    â†“
Re-render Components (Map, VenueCard list)
```

## éŸ¿æ‡‰å¼è¨­è¨ˆæ–·é»

```css
/* Tailwind é è¨­æ–·é» */
sm: 640px   /* æ‰‹æ©Ÿæ©«å‘ */
md: 768px   /* å¹³æ¿ç›´å‘ */
lg: 1024px  /* å¹³æ¿æ©«å‘ / å°ç­†é›» */
xl: 1280px  /* æ¡Œé¢ */
2xl: 1536px /* å¤§è¢å¹• */
```

**æ‡‰ç”¨ç­–ç•¥**:
- é è¨­: Mobile-Firstï¼ˆ< 640pxï¼‰
- å´é‚Šæ¬„: åœ¨ `md` ä»¥ä¸‹é¡¯ç¤ºç‚º overlay
- æœå°‹æ¬„: åœ¨ `md` ä»¥ä¸‹éš±è—éƒ¨åˆ†æ–‡å­—
- åœ°åœ–æ§åˆ¶é …: åœ¨æ‰€æœ‰å°ºå¯¸ä¿æŒå¯è¦‹

## å®‰å…¨æ€§è€ƒé‡

### 1. ç„¡éœ€ API Key ğŸ‰

- ä½¿ç”¨ MapLibre + OpenFreeMapï¼Œå®Œå…¨ç„¡éœ€ API Token
- é›¶é…ç½®ï¼Œç„¡éœ€æ“”å¿ƒ Key æ´©æ¼æˆ–æ¿«ç”¨å•é¡Œ
- çœŸæ­£çš„ 100% å…è²»æ–¹æ¡ˆ

### 2. é‡‘çµ²é›€æ•¸æ“š

```typescript
// åœ¨è³‡æ–™å­˜å–å±¤è‡ªå‹•éæ¿¾
this.venues = venuesData.venues.filter(v => !v.is_canary);
```

### 3. XSS é˜²è­·

- React è‡ªå‹•è½‰ç¾© HTML
- ä½¿ç”¨è€…è¼¸å…¥é€é `textContent` è€Œé `innerHTML`

## æ“´å±•è·¯å¾‘

### Phase 2: æ·»åŠ å¾Œç«¯åŠŸèƒ½

```
app/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ venues/
â”‚   â”‚   â””â”€â”€ route.ts      # GET /api/venues
â”‚   â”œâ”€â”€ checkin/
â”‚   â”‚   â””â”€â”€ route.ts      # POST /api/checkin
â”‚   â””â”€â”€ auth/
â”‚       â””â”€â”€ route.ts      # Authentication
```

### Phase 3: å¤šèªè¨€æ”¯æ´

```
app/
â”œâ”€â”€ [lang]/
â”‚   â”œâ”€â”€ page.tsx
â”‚   â””â”€â”€ layout.tsx
â”œâ”€â”€ i18n/
â”‚   â”œâ”€â”€ zh-TW.json
â”‚   â””â”€â”€ en.json
```

## æ¸¬è©¦ç­–ç•¥ï¼ˆæœªä¾†ï¼‰

### å–®å…ƒæ¸¬è©¦
- çµ„ä»¶æ¸¬è©¦: Jest + React Testing Library
- è³‡æ–™å±¤æ¸¬è©¦: Mock IVenueDataSource

### E2E æ¸¬è©¦
- Playwright æˆ– Cypress
- æ¸¬è©¦é—œéµç”¨æˆ¶æµç¨‹ï¼ˆæœå°‹ã€ç¯©é¸ã€é»æ“Šï¼‰

### è¦–è¦ºå›æ­¸æ¸¬è©¦
- Chromatic æˆ– Percy
- ç¢ºä¿ UI æ›´æ–°ä¸ç ´å£æ¨£å¼

## ç›£æ§èˆ‡åˆ†æï¼ˆæœªä¾†ï¼‰

- **éŒ¯èª¤è¿½è¹¤**: Sentry
- **åˆ†æ**: Vercel Analytics / Google Analytics
- **æ€§èƒ½**: Lighthouse CI
- **ç”¨æˆ¶è¡Œç‚º**: Hotjar / Mixpanel

---

**æ–‡ä»¶ç‰ˆæœ¬**: 1.0.0
**æœ€å¾Œæ›´æ–°**: 2026-01-30
